<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Latice sa pricom - Realizovane porud≈æbine</title>
<link rel="stylesheet" href="style.css?v=2">
<script src="script.js"></script>
</head>
<body>

<!-- Navigation bar -->
<nav class="topnav">
  <button class="hamburger" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="nav-menu">
    <a href="index.html">Dodaj porud≈æbinu</a>
    <a href="porudzbenice.html">Nove porud≈æbine</a>
    <a href="realizovano.html">Realizovane porud≈æbine</a>
    <a href="za_daostavu.html">Za dostavu</a>
    <a href="lager.html">Lager</a>
    <a href="podesavanja.html">‚öô Pode≈°avanja</a>
  </div>
  <button class="theme-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
</nav>

<div class="container">
<h1>Realizovane porud≈æbine</h1>

<div class="summary-box">
  <div class="summary-item">
    <span class="summary-label">Ukupno realizovano:</span>
    <span class="summary-value" id="totalSum">0.00 RSD</span>
  </div>
  <div class="summary-item">
    <span class="summary-label">Broj porud≈æbina:</span>
    <span class="summary-value" id="totalCount">0</span>
  </div>
</div>

<table id="shippingTable">
<thead>
<tr>
    <th>Naziv</th>
    <th>Cena</th>
    <th>Plaƒáeno</th>
    <th>Kupac</th>
    <th>Datum</th>
    <th>Opis</th>
    <th>Slika</th>
    <th>Akcija</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
function formatOpis(opis) {
    if (!opis || opis === '-') return '-';
    const lines = opis.split(/\r\n|\n/).filter(l => l.trim());
    let kolLines = [];
    let detalji = [];
    let inDetalji = false;
    for (const line of lines) {
        if (line.startsWith('Detalji:')) {
            inDetalji = true;
            detalji.push(line.replace('Detalji:', '').trim());
        } else if (inDetalji) {
            detalji.push(line);
        } else {
            const m = line.match(/^(\d+)\s+(.+)/);
            kolLines.push(m ? m[1] + ' x ' + m[2] : line);
        }
    }
    let html = '';
    if (kolLines.length) html += '<strong>Koliƒçina:</strong><br>' + kolLines.join('<br>');
    if (detalji.length) html += (html ? '<br>' : '') + '<strong>Detalji:</strong><br>' + detalji.join('<br>');
    return html || '-';
}
async function loadToBeShipped() {
    const res = await fetch('/orders/realized');
    const orders = await res.json();
    const tbody = document.querySelector('#shippingTable tbody');
    tbody.innerHTML = '';

    // Calculate totals
    const totalSum = orders.reduce((sum, o) => sum + (parseFloat(o.cena) || 0), 0);
    document.getElementById('totalSum').textContent = totalSum.toLocaleString('sr-RS', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' RSD';
    document.getElementById('totalCount').textContent = orders.length;

    orders.forEach(order => {
        const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="Naziv">${order.naziv}</td>
                <td data-label="Cena">${order.cena}</td>
                <td data-label="Plaƒáeno">${order.placeno ? '‚úÖ' : '‚ùå'}</td>
                <td data-label="Kupac">${order.kupac}</td>
                <td data-label="Datum">${order.datum || '-'}</td>
                <td data-label="Opis" class="td-opis">${formatOpis(order.opis)}</td>
                <td data-label="Slika"><img src="/images/${order.slika}" /></td>
                <td data-label="Akcija"><button onclick="editOrder(${order.id})">Izmeni</button></td>
            `;
            tbody.appendChild(tr);
    });
}

// initial load
loadToBeShipped();

function editOrder(id) {
    window.location.href = `edit.html?id=${id}`;
}
</script>

</body>
</html>
