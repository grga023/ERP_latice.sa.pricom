{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="container">
<h1>âš™ Settings</h1>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EMAIL NOTIFICATIONS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-card">
    <h2>ğŸ“§ Email Notifications</h2>
    <p class="settings-desc">You will receive email notifications when an order has a deadline within the next N days. Use Gmail with App Password.</p>

    <form id="emailForm" class="settings-form">
        <div class="form-field">
            <label>Notifications:</label>
            <select id="emailEnabled">
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
            </select>
        </div>

        <div class="form-field">
            <label>Gmail for sending:</label>
            <input type="email" id="senderEmail" placeholder="your.email@gmail.com" required>
        </div>

        <div class="form-field">
            <label>App Password:</label>
            <input type="password" id="appPassword" placeholder="Enter Gmail App Password">
            <small id="passwordHint" style="color: var(--text-secondary);"></small>
        </div>

        <div class="form-field">
            <label>Recipient (email):</label>
            <input type="text" id="receiverEmail" placeholder="email1@gmail.com, email2@gmail.com" required>
            <small style="color: var(--text-secondary);">Separate multiple addresses with commas</small>
        </div>

        <div class="form-field">
            <label>Days before deadline:</label>
            <input type="number" id="daysBefore" min="1" max="14" value="2">
        </div>

        <div class="settings-buttons">
            <button type="submit">ğŸ’¾ Save</button>
            <button type="button" onclick="testEmail()">ğŸ“¨ Test Email</button>
            <button type="button" onclick="triggerCheck()">ğŸ”” Check Now</button>
        </div>
    </form>

    <div id="emailStatusMsg" class="status-msg" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BUSINESS SETTINGS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-card" style="margin-top: 30px;">
    <h2>ğŸ¢ Business information</h2>
    <p class="settings-desc">Basic information displayed in the application.</p>

    <form id="businessForm" class="settings-form">
        <div class="form-field">
            <label>Business Name:</label>
            <input type="text" id="businessName" placeholder="My Business">
        </div>

        <div class="form-field">
            <label>Short Name (navbar):</label>
            <input type="text" id="businessShortName" placeholder="My Business">
        </div>

        <div class="form-field">
            <label>Email:</label>
            <input type="email" id="businessEmail" placeholder="contact@mybusiness.com">
        </div>

        <div class="form-field">
            <label>Telefon:</label>
            <input type="tel" id="businessPhone" placeholder="+381 11 123 4567">
        </div>

        <div class="form-field">
            <label>Adresa:</label>
            <input type="text" id="businessAddress" placeholder="Street and number, City">
        </div>

        <div class="form-field">
            <label>Website:</label>
            <input type="url" id="businessWebsite" placeholder="https://www.mojbiznis.com">
        </div>

        <div class="settings-buttons">
            <button type="submit">ğŸ’¾ Save</button>
        </div>
    </form>

    <div id="businessStatusMsg" class="status-msg" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REGIONAL SETTINGS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-card" style="margin-top: 30px;">
    <h2>ğŸŒ Regional Settings</h2>
    <p class="settings-desc">Currency and time zone.</p>

    <form id="localeForm" class="settings-form">
        <div class="form-field">
            <label>Currency:</label>
            <select id="currency">
                <option value="RSD">RSD - Serbian Dinar</option>
                <option value="EUR">EUR - Euro</option>
                <option value="USD">USD - US Dollar</option>
                <option value="BAM">BAM - Convertible Mark</option>
                <option value="HRK">HRK - Croatian Kuna</option>
            </select>
        </div>

        <div class="form-field">
            <label>Time Zone:</label>
            <select id="timezone">
                <option value="Europe/Belgrade">Europe/Belgrade</option>
                <option value="Europe/Zagreb">Europe/Zagreb</option>
                <option value="Europe/Sarajevo">Europe/Sarajevo</option>
                <option value="UTC">UTC</option>
            </select>
        </div>

        <div class="settings-buttons">
            <button type="submit">ğŸ’¾ Save</button>
        </div>
    </form>

    <div id="localeStatusMsg" class="status-msg" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BRANDING
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-card" style="margin-top: 30px;">
    <h2>ğŸ¨ Branding</h2>
    <p class="settings-desc">Logo and app colors.</p>

    <div class="branding-uploads">
        <div class="branding-item">
            <label>Logo (large):</label>
            <div class="upload-box" onclick="document.getElementById('logoUpload').click()">
                <img id="logoPreview" src="/images/branding/logo.png" onerror="this.style.display='none'" style="max-height: 60px;">
                <span>ğŸ“¤ Klikni za upload</span>
            </div>
            <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="uploadBranding('logo', this)">
        </div>

        <div class="branding-item">
            <label>Logo (small, navbar):</label>
            <div class="upload-box" onclick="document.getElementById('logoSmallUpload').click()">
                <img id="logoSmallPreview" src="/images/branding/logo-small.png" onerror="this.style.display='none'" style="max-height: 40px;">
                <span>ğŸ“¤ Klikni za upload</span>
            </div>
            <input type="file" id="logoSmallUpload" accept="image/*" style="display:none" onchange="uploadBranding('logoSmall', this)">
        </div>

        <div class="branding-item">
            <label>Favicon:</label>
            <div class="upload-box" onclick="document.getElementById('faviconUpload').click()">
                <img id="faviconPreview" src="/images/branding/favicon.ico" onerror="this.style.display='none'" style="max-height: 32px;">
                <span>ğŸ“¤ Klikni za upload</span>
            </div>
            <input type="file" id="faviconUpload" accept="image/*,.ico" style="display:none" onchange="uploadBranding('favicon', this)">
        </div>
    </div>

    <form id="brandingForm" class="settings-form" style="margin-top: 20px;">
        <div class="form-field">
            <label>Primarna color:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="primaryColor" value="#4F46E5" style="width: 60px; height: 40px; padding: 0; border: none;">
                <input type="text" id="primaryColorText" value="#4F46E5" style="width: 100px;">
            </div>
        </div>

        <div class="form-field">
            <label>Sekundarna color:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="secondaryColor" value="#10B981" style="width: 60px; height: 40px; padding: 0; border: none;">
                <input type="text" id="secondaryColorText" value="#10B981" style="width: 100px;">
            </div>
        </div>

        <div class="settings-buttons">
            <button type="submit">ğŸ’¾ Save colors</button>
        </div>
    </form>

    <div id="brandingStatusMsg" class="status-msg" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SISTEM INFO
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-card" style="margin-top: 30px;">
    <h2>â„¹ï¸ Sistem</h2>
    <p class="settings-desc">Informacije o sistemu.</p>

    <div class="system-info">
        <div class="info-row"><span>Verzija:</span> <span id="sysVersion">-</span></div>
        <div class="info-row"><span>Server:</span> <span id="sysServer">-</span></div>
    </div>

    <div class="settings-buttons" style="margin-top: 15px;">
        <button type="button" onclick="checkHealth()">ğŸ¥ Health Check</button>
    </div>

    <div id="systemStatusMsg" class="status-msg" style="display:none;"></div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utility funkcije
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showStatus(elementId, msg, ok) {
    const el = document.getElementById(elementId);
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = ok ? '#d4edda' : '#f8d7da';
    el.style.color = ok ? '#155724' : '#721c24';
    el.style.border = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Email notifikacije (tvoj originalni kod)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadEmailConfig() {
    try {
        const res = await fetch('/api/email_config');
        const config = await res.json();
        document.getElementById('emailEnabled').value = config.enabled ? 'true' : 'false';
        document.getElementById('senderEmail').value = config.sender_email || '';
        document.getElementById('receiverEmail').value = config.receiver_email || '';
        document.getElementById('daysBefore').value = config.days_before || 2;
        if (config.has_password) {
            document.getElementById('passwordHint').textContent = 'âœ… Password is saved. Leave empty if you are not changing it.';
        }
    } catch (err) {
        console.error('Error loading email config:', err);
    }
}

document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        enabled: document.getElementById('emailEnabled').value === 'true',
        sender_email: document.getElementById('senderEmail').value,
        receiver_email: document.getElementById('receiverEmail').value,
        days_before: parseInt(document.getElementById('daysBefore').value),
    };
    const pw = document.getElementById('appPassword').value;
    if (pw) data.app_password = pw;

    try {
        const res = await fetch('/api/email_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            showStatus('emailStatusMsg', 'Settings saved!', true);
            document.getElementById('appPassword').value = '';
            loadEmailConfig();
        } else {
            showStatus('emailStatusMsg', 'Error saving.', false);
        }
    } catch (err) {
        showStatus('emailStatusMsg', 'Connection error.', false);
    }
});

async function testEmail() {
    showStatus('emailStatusMsg', 'Sending test email...', true);
    try {
        const res = await fetch('/api/test_email', { method: 'POST' });
        const data = await res.json();
        if (data.ok) showStatus('emailStatusMsg', 'âœ… Test email sent successfully!', true);
        else showStatus('emailStatusMsg', 'âŒ Error: ' + (data.error || 'Failed to send.'), false);
    } catch (err) {
        showStatus('emailStatusMsg', 'Connection error.', false);
    }
}

async function triggerCheck() {
    showStatus('emailStatusMsg', 'Checking orders...', true);
    try {
        const res = await fetch('/api/check_notifications', { method: 'POST' });
        if (res.ok) showStatus('emailStatusMsg', 'âœ… Verification completed! Ako ima order sa bliskim rokom, email je poslat.', true);
        else showStatus('emailStatusMsg', 'Error checking.', false);
    } catch (err) {
        showStatus('emailStatusMsg', 'Connection error.', false);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config (biznis, locale, branding)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let appConfig = {};

async function loadAppConfig() {
    try {
        const res = await fetch('/api/config');
        appConfig = await res.json();
        
        // Business
        if (appConfig.business) {
            document.getElementById('businessName').value = appConfig.business.name || '';
            document.getElementById('businessShortName').value = appConfig.business.shortName || '';
            document.getElementById('businessEmail').value = appConfig.business.email || '';
            document.getElementById('businessPhone').value = appConfig.business.phone || '';
            document.getElementById('businessAddress').value = appConfig.business.address || '';
            document.getElementById('businessWebsite').value = appConfig.business.website || '';
        }
        
        // Locale
        if (appConfig.locale) {
            document.getElementById('currency').value = appConfig.locale.currency || 'RSD';
            document.getElementById('timezone').value = appConfig.locale.timezone || 'Europe/Belgrade';
        }
        
        // Branding
        if (appConfig.branding) {
            document.getElementById('primaryColor').value = appConfig.branding.primaryColor || '#4F46E5';
            document.getElementById('primaryColorText').value = appConfig.branding.primaryColor || '#4F46E5';
            document.getElementById('secondaryColor').value = appConfig.branding.secondaryColor || '#10B981';
            document.getElementById('secondaryColorText').value = appConfig.branding.secondaryColor || '#10B981';
        }
        
        // Version
        document.getElementById('sysVersion').textContent = appConfig.version || '1.0.0';
        document.getElementById('sysServer').textContent = window.location.host;
        
    } catch (err) {
        console.error('Error loading config:', err);
    }
}

async function saveConfig() {
    try {
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(appConfig)
        });
        return res.ok;
    } catch (err) {
        return false;
    }
}

// Business form
document.getElementById('businessForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    appConfig.business = {
        name: document.getElementById('businessName').value,
        shortName: document.getElementById('businessShortName').value,
        email: document.getElementById('businessEmail').value,
        phone: document.getElementById('businessPhone').value,
        address: document.getElementById('businessAddress').value,
        website: document.getElementById('businessWebsite').value
    };
    
    if (await saveConfig()) {
        showStatus('businessStatusMsg', 'âœ… Business information saved!', true);
    } else {
        showStatus('businessStatusMsg', 'âŒ Error saving.', false);
    }
});

// Locale form
document.getElementById('localeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    appConfig.locale = {
        currency: document.getElementById('currency').value,
        timezone: document.getElementById('timezone').value
    };
    
    if (await saveConfig()) {
        showStatus('localeStatusMsg', 'âœ… Regional settings saved!', true);
    } else {
        showStatus('localeStatusMsg', 'âŒ Error saving.', false);
    }
});

// Branding form
document.getElementById('brandingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!appConfig.branding) appConfig.branding = {};
    appConfig.branding.primaryColor = document.getElementById('primaryColor').value;
    appConfig.branding.secondaryColor = document.getElementById('secondaryColor').value;
    
    if (await saveConfig()) {
        showStatus('brandingStatusMsg', 'âœ… Colors saved!', true);
    } else {
        showStatus('brandingStatusMsg', 'âŒ Error saving.', false);
    }
});

// Sync color pickers
document.getElementById('primaryColor').addEventListener('input', function() {
    document.getElementById('primaryColorText').value = this.value;
});
document.getElementById('primaryColorText').addEventListener('input', function() {
    document.getElementById('primaryColor').value = this.value;
});
document.getElementById('secondaryColor').addEventListener('input', function() {
    document.getElementById('secondaryColorText').value = this.value;
});
document.getElementById('secondaryColorText').addEventListener('input', function() {
    document.getElementById('secondaryColor').value = this.value;
});

// Upload branding
async function uploadBranding(type, input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('type', type);

    try {
        const response = await fetch('/api/config/branding', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.status === 'ok') {
            // Update preview
            const previewId = type + 'Preview';
            document.getElementById(previewId).src = result.path + '?t=' + Date.now();
            document.getElementById(previewId).style.display = 'block';
            showStatus('brandingStatusMsg', 'âœ… ' + type + ' successfully uploaded!', true);
        } else {
            showStatus('brandingStatusMsg', 'âŒ Error: ' + result.error, false);
        }
    } catch (err) {
        showStatus('brandingStatusMsg', 'âŒ Error uploading.', false);
    }
}

// Health check
async function checkHealth() {
    try {
        const res = await fetch('/health');
        const data = await res.json();
        if (data.status === 'healthy') {
            showStatus('systemStatusMsg', 'âœ… Server je zdrav! DB: ' + data.database, true);
        } else {
            showStatus('systemStatusMsg', 'âš ï¸ Server ima problema.', false);
        }
    } catch (err) {
        showStatus('systemStatusMsg', 'âŒ Server nije dostupan.', false);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Inicijalizacija
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

loadEmailConfig();
loadAppConfig();
</script>

<style>
/* Additional CSS za novu stranicu */
.branding-uploads {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.branding-item {
    text-align: center;
}

.branding-item label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.9rem;
}

.upload-box {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.upload-box:hover {
    border-color: var(--button-bg);
    background: rgba(0, 86, 179, 0.05);
}

.upload-box img {
    max-width: 100%;
    object-fit: contain;
}

.upload-box span {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.system-info {
    background: var(--bg-primary);
    border-radius: 8px;
    padding: 15px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.info-row:last-child {
    border-bottom: none;
}

.info-row span:first-child {
    font-weight: 600;
}
</style>
{% endblock %}
