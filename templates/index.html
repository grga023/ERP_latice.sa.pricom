{% extends "base.html" %}

{% block title %}Dodaj porud≈æbinu{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="container" id="form-container">
<h1>Dodaj porud≈æbinu</h1>

<form id="orderForm" enctype="multipart/form-data">
    <div class="form-field">
        <label>Naziv proizvoda:</label>
        <input type="text" name="naziv" required>
    </div>

    <div class="form-field">
        <label>Cena:</label>
        <input type="number" name="cena" step="0.01" required>
    </div>

    <div class="form-field">
        <label>Plaƒáeno:</label>
        <select name="placeno">
            <option value="false">Ne</option>
            <option value="true">Da</option>
        </select>
    </div>

    <div class="form-field">
        <label>Kupac:</label>
        <input type="text" name="kupac" required>
    </div>

    <label>Datum:</label>
    <input type="date" id="datepicker" name="datum" required>

    <label>Koliƒçina i boja:</label>
    <div id="kombinacije-container">
        <div class="kombinacija-row">
            <input type="number" class="kolicina" min="1" value="1" placeholder="Koliƒçina" required>
            <input type="text" class="boja" value="razno" placeholder="Boja (npr. ≈æuto, plavo)" required>
            <button type="button" class="btn-remove" onclick="removeCombination(this)">√ó</button>
            <button type="button" class="btn-add" onclick="addCombination()">+ Dodaj boju</button>
        </div>
    </div>

    <label>Dodatna poruka:</label>
    <textarea id="customMessage" name="customMessage" placeholder="Dodatne napomene..."></textarea>
    
    <input type="hidden" name="opis" id="opisField">

    <div class="form-field">
        <label>Slika:</label>
        <div id="pasteArea" class="paste-area">
            <input type="file" id="fileInput" name="slika" accept="image/*" class="file-input">
            <p class="paste-hint">üìé Odaberi sliku ili pritisni CTRL+V</p>
        </div>
        <img id="preview" class="image-preview" alt="Preview slike" style="display: none;">
    </div>

    <button type="submit">Dodaj porud≈æbinu</button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>

const pasteArea = document.getElementById("pasteArea");
const preview = document.getElementById("preview");
const fileInput = document.getElementById("fileInput");

pasteArea.addEventListener("paste", function (e) {
  const items = e.clipboardData.items;

  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf("image") !== -1) {

      const file = items[i].getAsFile();

      // Preview
      const reader = new FileReader();
      reader.onload = function (event) {
        preview.src = event.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);

      // Ubaci u input file da se po≈°alje formom
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      break;
    }
  }
});
// Dark Mode Toggle
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    updateToggleText();
}

function initDarkMode() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
    updateToggleText();
}

function updateToggleText() {
    const toggle = document.querySelector('.theme-toggle');
    if (toggle) {
        toggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    }
}

initDarkMode();

// Add new combination row
function addCombination() {
    const container = document.getElementById('kombinacije-container');
    const newRow = document.createElement('div');
    newRow.className = 'kombinacija-row';
    newRow.innerHTML = `
        <input type="number" class="kolicina" min="1" value="1" placeholder="Koliƒçina" required>
        <input type="text" class="boja" value="razno" placeholder="Boja (npr. ≈æuto, plavo)" required>
        <button type="button" class="btn-remove" onclick="removeCombination(this)">√ó</button>
    `;
    container.appendChild(newRow);
}

// Remove combination row
function removeCombination(btn) {
    btn.parentElement.remove();
}

// Format combinations into the opis field
function formatCombinations() {
    const rows = document.querySelectorAll('.kombinacija-row');
    let formatted = '';
    
    rows.forEach(row => {
        const kolicina = row.querySelector('.kolicina').value;
        const boja = row.querySelector('.boja').value;
        if (kolicina && boja) {
            formatted += kolicina + ' ' + boja + '\r\n';
        }
    });
    
    const customMessage = document.getElementById('customMessage').value.trim();
    if (customMessage) {
        formatted += 'Detalji: ' + customMessage + '\r\n';
    }
    
    document.querySelector('#opisField').value = formatted;
}

const form = document.getElementById('orderForm');

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Format combinations before submitting
    formatCombinations();

    const formData = new FormData(form);

    // Calculate total quantity and first color
    const rows = document.querySelectorAll('.kombinacija-row');
    let totalKolicina = 0;
    let firstBoja = '';
    rows.forEach((row, index) => {
        const k = parseInt(row.querySelector('.kolicina').value) || 0;
        totalKolicina += k;
        if (index === 0) {
            firstBoja = row.querySelector('.boja').value || '';
        }
    });
    if (totalKolicina < 1) totalKolicina = 1;
    
    // Add kolicina and boja fields for backend
    formData.set('kolicina', totalKolicina);
    formData.set('boja', firstBoja);
    
    // Multiply price by total quantity
    const baseCena = parseFloat(formData.get('cena'));
    formData.set('cena', (baseCena * totalKolicina).toFixed(2));

    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let datumValue = document.querySelector('#datepicker').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = `${day}.${month}.${year}`;
    }
    formData.set('datum', datumValue);

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Porud≈æbina je uspe≈°no dodana!');
            form.reset();
            preview.style.display = 'none';
            // Reset kombinacije
            document.getElementById('kombinacije-container').innerHTML = `
                <div class="kombinacija-row">
                    <input type="number" class="kolicina" min="1" value="1" placeholder="Koliƒçina" required>
                    <input type="text" class="boja" value="razno" placeholder="Boja (npr. ≈æuto, plavo)" required>
                    <button type="button" class="btn-remove" onclick="removeCombination(this)">√ó</button>
                </div>
            `;
        } else {
            const errorData = await response.json();
            alert('Gre≈°ka pri dodavanju porud≈æbine: ' + (errorData.error || 'Nepoznata gre≈°ka'));
        }
    } catch (err) {
        console.error(err);
        alert('Gre≈°ka pri konektovanju na server: ' + err.message);
    }
});
</script>
{% endblock %}
