{% extends "base.html" %}

{% block title %}Pode≈°avanja{% endblock %}

{% block content %}
<div class="container">
<h1>‚öô Pode≈°avanja notifikacija</h1>

<div class="settings-card">
    <h2>üìß Email notifikacije</h2>
    <p class="settings-desc">Primaƒáe≈° email obave≈°tenje kada porud≈æbina ima rok u narednih N dana. Koristi≈° Gmail sa App Password-om.</p>

    <form id="emailForm" class="settings-form">
        <div class="form-field">
            <label>Notifikacije:</label>
            <select id="emailEnabled">
                <option value="false">Iskljuƒçeno</option>
                <option value="true">Ukljuƒçeno</option>
            </select>
        </div>

        <div class="form-field">
            <label>Gmail za slanje:</label>
            <input type="email" id="senderEmail" placeholder="tvoj.email@gmail.com" required>
        </div>

        <div class="form-field">
            <label>App Password:</label>
            <input type="password" id="appPassword" placeholder="Unesi Gmail App Password">
            <small id="passwordHint" style="color: var(--text-secondary);"></small>
        </div>

        <div class="form-field">
            <label>Primaoc (email):</label>
            <input type="text" id="receiverEmail" placeholder="email1@gmail.com, email2@gmail.com" required>
            <small style="color: var(--text-secondary);">Vi≈°e adresa razdvoji zarezom</small>
        </div>

        <div class="form-field">
            <label>Dana pre roka:</label>
            <input type="number" id="daysBefore" min="1" max="14" value="2">
        </div>

        <div class="settings-buttons">
            <button type="submit">üíæ Saƒçuvaj</button>
            <button type="button" onclick="testEmail()">üì® Test Email</button>
            <button type="button" onclick="triggerCheck()">üîî Proveri sad</button>
        </div>
    </form>

    <div id="statusMsg" class="status-msg" style="display:none;"></div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadConfig() {
    const res = await fetch('/api/email_config');
    const config = await res.json();
    document.getElementById('emailEnabled').value = config.enabled ? 'true' : 'false';
    document.getElementById('senderEmail').value = config.sender_email || '';
    document.getElementById('receiverEmail').value = config.receiver_email || '';
    document.getElementById('daysBefore').value = config.days_before || 2;
    if (config.has_password) {
        document.getElementById('passwordHint').textContent = '‚úÖ Password je saƒçuvan. Ostavi prazno ako ne menja≈°.';
    }
}

function showStatus(msg, ok) {
    const el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = ok ? '#d4edda' : '#f8d7da';
    el.style.color = ok ? '#155724' : '#721c24';
    el.style.border = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        enabled: document.getElementById('emailEnabled').value === 'true',
        sender_email: document.getElementById('senderEmail').value,
        receiver_email: document.getElementById('receiverEmail').value,
        days_before: parseInt(document.getElementById('daysBefore').value),
    };
    const pw = document.getElementById('appPassword').value;
    if (pw) data.app_password = pw;

    try {
        const res = await fetch('/api/email_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            showStatus('Pode≈°avanja su saƒçuvana!', true);
            document.getElementById('appPassword').value = '';
            loadConfig();
        } else {
            showStatus('Gre≈°ka pri ƒçuvanju.', false);
        }
    } catch (err) {
        showStatus('Gre≈°ka pri konekciji.', false);
    }
});

async function testEmail() {
    showStatus('≈†aljem test email...', true);
    try {
        const res = await fetch('/api/test_email', { method: 'POST' });
        const data = await res.json();
        if (data.ok) showStatus('‚úÖ Test email je uspe≈°no poslat!', true);
        else showStatus('‚ùå Gre≈°ka: ' + (data.error || 'Neuspelo slanje.'), false);
    } catch (err) {
        showStatus('Gre≈°ka pri konekciji.', false);
    }
}

async function triggerCheck() {
    showStatus('Proveravam porud≈æbine...', true);
    try {
        const res = await fetch('/api/check_notifications', { method: 'POST' });
        if (res.ok) showStatus('‚úÖ Provera zavr≈°ena! Ako ima porud≈æbina sa bliskim rokom, email je poslat.', true);
        else showStatus('Gre≈°ka pri proveri.', false);
    } catch (err) {
        showStatus('Gre≈°ka pri konekciji.', false);
    }
}

loadConfig();
</script>
{% endblock %}
