{% extends "base.html" %}

{% block title %}Lager{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">üì¶ Lager</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Upravljanje zalihama i artiklima</p>
</div>

<!-- Add Lager Item Form -->
<div class="form-container mb-5 fade-in">
  <div class="card-header mb-4">
    <h2 class="card-title">‚ûï Dodaj Novi Artikal</h2>
  </div>

<form id="lagerForm" enctype="multipart/form-data">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naziv *</label>
        <input type="text" name="naziv" class="form-input" placeholder="Naziv artikla" required>
      </div>

      <div class="form-group">
        <label class="form-label">Cena *</label>
        <input type="number" name="cena" step="0.01" class="form-input" placeholder="0.00" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Boja *</label>
        <input type="text" name="boja" class="form-input" placeholder="npr. crvena, plava" required>
      </div>

      <div class="form-group">
        <label class="form-label">Quantity *</label>
        <input type="number" name="kolicina" min="0" value="1" class="form-input" required>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Lokacija</label>
      <select name="lokacija" class="form-select">
        <option value="Home">Home</option>
        <option value="Teodora">Teodora</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Slika</label>
      <div id="pasteArea" class="image-upload" style="position: relative;">
        <input type="file" id="fileInput" name="slika" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
        <p style="margin: 0; font-weight: 500; color: var(--gray);">üìé Kliknite da odaberete ili pritisnite CTRL+V</p>
      </div>
      <img id="preview" class="image-preview mt-3" alt="Preview slike" style="display: none;">
    </div>

    <div class="btn-group mt-4">
      <button type="submit" class="btn btn-primary btn-lg w-full">
        <span>‚ú®</span>
        <span>Dodaj u Lager</span>
      </button>
    </div>
</form>
</div>

<!-- Lager Table -->
<div class="page-header mb-3">
  <h2 style="font-size: 2rem; font-weight: 700; color: #1a1a1a;">Pregled Lagera</h2>
</div>

<div class="table-container fade-in">
  <table id="lagerTable" class="modern-table">
    <thead>
      <tr>
        <th>Slika</th>
        <th>Naziv</th>
        <th>Cena</th>
        <th>Boja</th>
        <th>Quantity</th>
        <th>Lokacija</th>
        <th>Akcija</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Popup modal for increasing quantity -->
<div id="increaseModal" class="modal-overlay">
    <div class="card" style="max-width: 400px; margin: 100px auto; position: relative;">
        <span class="modal-close" onclick="closeIncreaseModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--gray); transition: color 0.2s;">&times;</span>
        
        <div class="card-header mb-3">
          <h2 class="card-title">‚ûï Add Quantity</h2>
        </div>
        
        <div class="mb-3" style="padding: 1rem; background: var(--glass-bg); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
            <strong id="increaseNaziv" style="display: block; font-size: 1.1rem; margin-bottom: 0.5rem;"></strong>
            <span id="increaseCurrentQty" style="color: var(--gray);"></span>
        </div>
        
        <form id="increaseQuantityForm">
            <input type="hidden" id="increaseItemId">
            
            <div class="form-group">
              <label class="form-label">Quantity za dodavanje</label>
              <input type="number" id="increaseAmount" min="1" value="1" class="form-input" required autofocus>
            </div>
            
            <button type="submit" class="btn btn-primary w-full mt-3">Potvrdi</button>
        </form>
    </div>
</div>

<!-- Popup modal for creating order from inventory -->
<div id="orderModal" class="modal-overlay">
    <div class="card" style="max-width: 500px; margin: 80px auto; position: relative;">
        <span class="modal-close" onclick="closeOrderModal()" style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: var(--gray); transition: color 0.2s;">&times;</span>
        
        <div class="card-header mb-3">
          <h2 class="card-title">üõçÔ∏è Create Order</h2>
        </div>
        
        <div class="modal-preview mb-4" style="display: flex; gap: 1rem; padding: 1rem; background: var(--glass-bg); border-radius: var(--radius-lg); border: 1px solid var(--glass-border);">
            <img id="modalImg" src="" alt="Slika artikla" style="width: 80px; height: 80px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--glass-border);">
            <div style="flex: 1;">
                <strong id="modalNaziv" style="display: block; font-size: 1.1rem; margin-bottom: 0.5rem;"></strong>
                <span id="modalCena" style="display: block; color: var(--primary); font-weight: 600; margin-bottom: 0.25rem;"></span>
                <span id="modalBoja" style="display: block; color: var(--gray);"></span>
            </div>
        </div>
        
        <form id="orderFromLagerForm">
            <input type="hidden" id="modalLagerNaziv">
            <input type="hidden" id="modalLagerCena">
            <input type="hidden" id="modalLagerBoja">
            <input type="hidden" id="modalLagerSlika">
            <input type="hidden" id="modalLagerId">
            <input type="hidden" id="modalLagerStock">

            <div class="form-group">
              <label class="form-label" style="font-weight: 700;">Kupac</label>
              <input type="text" id="modalKupac" class="form-input" placeholder="Ime kupca" required>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Quantity</label>
                <input type="number" id="modalKolicina" min="1" value="1" class="form-input" required>
              </div>

              <div class="form-group">
                <label class="form-label">Datum</label>
                <div style="overflow: hidden; width: 100%; max-width: 100%;">
                  <input type="date" id="modalDatum" class="form-input" required style="width: 100%; max-width: 100%; box-sizing: border-box; margin: 0; font-size: 14px;">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Paid</label>
              <select id="modalPlaceno" class="form-select">
                <option value="false">Ne</option>
                <option value="true">Da</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Dodatna poruka</label>
              <textarea id="modalOpis" class="form-input" rows="3" placeholder="Dodatne napomene..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-full mt-3">üöÄ Create Order</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Paste image support
const pasteArea = document.getElementById("pasteArea");
const preview = document.getElementById("preview");
const fileInput = document.getElementById("fileInput");

pasteArea.addEventListener("paste", function (e) {
    const items = e.clipboardData.items;
    for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
            const file = items[i].getAsFile();
            const reader = new FileReader();
            reader.onload = function (event) {
                preview.src = event.target.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            break;
        }
    }
});

fileInput.addEventListener("change", function () {
    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function (event) {
            preview.src = event.target.result;
            preview.style.display = "block";
        };
        reader.readAsDataURL(fileInput.files[0]);
    }
});

// Load lager items
async function loadLager() {
    const res = await fetch('/api/lager');
    const items = await res.json();
    const tbody = document.querySelector('#lagerTable tbody');
    tbody.innerHTML = '';

    items.forEach(item => {
        const outOfStock = (item.kolicina || 0) <= 0;
        const tr = document.createElement('tr');
        if (outOfStock) tr.style.opacity = '0.6';
        
        // Escape special characters for safe HTML insertion
        const escapedNaziv = (item.naziv || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        const escapedBoja = (item.boja || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        const escapedSlika = (item.slika || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
        
        tr.innerHTML = `
            <td data-label="Slika">${item.slika ? '<img src="/images/' + item.slika + '" style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid var(--glass-border);" />' : '<span style="color: var(--gray);">-</span>'}</td>
            <td data-label="Naziv"><strong>${item.naziv}</strong></td>
            <td data-label="Cena"><span style="color: var(--primary); font-weight: 600;">${item.cena} RSD</span></td>
            <td data-label="Boja">${item.boja}</td>
            <td data-label="Quantity">${outOfStock ? '<span class="badge badge-danger">Unavailable</span>' : '<span class="badge badge-success">' + item.kolicina + '</span>'}</td>
            <td data-label="Lokacija">${item.lokacija || '-'}</td>
            <td data-label="Akcija">
                <div class="btn-group">
                    <button onclick="openOrderModal(${item.id}, '${escapedNaziv}', ${item.cena}, '${escapedBoja}', '${escapedSlika}', ${item.kolicina || 0})" class="btn btn-primary btn-sm">üõçÔ∏è Order</button>
                    <button onclick="openIncreaseModal(${item.id}, '${escapedNaziv}', ${item.kolicina || 0})" class="btn btn-secondary btn-sm">‚ûï Dodaj</button>
                    <button onclick="deleteLager(${item.id})" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Delete lager item
async function deleteLager(id) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    try {
        const res = await fetch('/api/lager/' + id, { method: 'DELETE' });
        if (res.ok) loadLager();
        else alert('Error deleting.');
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
}

// Submit form
const form = document.getElementById('lagerForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    try {
        const response = await fetch('/api/lager', {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            alert('Item successfully added to inventory!');
            form.reset();
            preview.style.display = 'none';
            loadLager();
        } else {
            alert('Error adding to inventory.');
        }
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
});

// Initial load
loadLager();

// --- Increase Quantity Modal ---
function openIncreaseModal(itemId, naziv, currentQty) {
    document.getElementById('increaseItemId').value = itemId;
    document.getElementById('increaseNaziv').textContent = naziv;
    document.getElementById('increaseCurrentQty').textContent = 'Trenutna quantity: ' + currentQty;
    document.getElementById('increaseAmount').value = 1;
    document.getElementById('increaseModal').classList.add('active');
    setTimeout(() => document.getElementById('increaseAmount').focus(), 100);
}

function closeIncreaseModal() {
    document.getElementById('increaseModal').classList.remove('active');
}

// Close modal on overlay click
document.getElementById('increaseModal').addEventListener('click', function(e) {
    if (e.target === this) closeIncreaseModal();
});

// Submit increase quantity
document.getElementById('increaseQuantityForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const itemId = document.getElementById('increaseItemId').value;
    const quantity = parseInt(document.getElementById('increaseAmount').value);
    
    if (quantity <= 0) {
        alert('Quantity must be greater than 0!');
        return;
    }
    
    try {
        const res = await fetch('/api/lager/' + itemId + '/increase_quantity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity: quantity })
        });
        if (res.ok) {
            const data = await res.json();
            alert('Quantity was successfully updated! Nova quantity: ' + data.new_quantity);
            closeIncreaseModal();
            loadLager();
        } else {
            alert('Error updating quantity.');
        }
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
});

// --- Order from Lager Modal ---
function openOrderModal(lagerId, naziv, cena, boja, slika, stock) {
    const imgElement = document.getElementById('modalImg');
    if (slika && slika.trim() !== '') {
        imgElement.src = '/images/' + slika;
        imgElement.style.display = 'block';
    } else {
        imgElement.src = '';
        imgElement.style.display = 'none';
    }
    document.getElementById('modalNaziv').textContent = naziv;
    document.getElementById('modalCena').textContent = 'Cena: ' + cena;
    document.getElementById('modalBoja').textContent = 'Boja: ' + boja;
    document.getElementById('modalLagerNaziv').value = naziv;
    document.getElementById('modalLagerCena').value = cena;
    document.getElementById('modalLagerBoja').value = boja;
    document.getElementById('modalLagerSlika').value = slika;
    document.getElementById('modalLagerId').value = lagerId;
    document.getElementById('modalLagerStock').value = stock;
    document.getElementById('modalKupac').value = '';
    document.getElementById('modalKolicina').value = 1;
    document.getElementById('modalDatum').value = '';
    document.getElementById('modalPlaceno').value = 'false';
    document.getElementById('modalOpis').value = '';
    // Show stock warning if out of stock
    let warn = document.getElementById('stockWarning');
    if (!warn) {
        warn = document.createElement('div');
        warn.id = 'stockWarning';
        warn.className = 'stock-warning';
        document.querySelector('.modal-preview').after(warn);
    }
    if (stock <= 0) {
        warn.textContent = '‚ö†Ô∏è Product unavailable in inventory! You can create an order ali se quantity won't be deducted.';
        warn.className = 'stock-warning stock-warning-red';
        warn.style.display = 'block';
    } else {
        warn.textContent = 'üì¶ Na lageru: ' + stock;
        warn.className = 'stock-warning';
        warn.style.display = 'block';
    }
    document.getElementById('orderModal').classList.add('active');
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('active');
}

// Close modal on overlay click
document.getElementById('orderModal').addEventListener('click', function(e) {
    if (e.target === this) closeOrderModal();
});

// Close modal on Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeOrderModal();
        closeIncreaseModal();
    }
});

// Submit order from lager
document.getElementById('orderFromLagerForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    let datumValue = document.getElementById('modalDatum').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = day + '.' + month + '.' + year;
    }

    const baseCena = parseFloat(document.getElementById('modalLagerCena').value);
    const kolicina = parseInt(document.getElementById('modalKolicina').value) || 1;
    const totalCena = (baseCena * kolicina).toFixed(2);
    const boja = document.getElementById('modalLagerBoja').value;
    const opisText = document.getElementById('modalOpis').value.trim();

    // Build formatted description: "quantity color\nDetails: description"
    let formattedOpis = kolicina + ' ' + (boja || 'Razno') + '\r\n';
    if (opisText) {
        formattedOpis += 'Detalji: ' + opisText + '\r\n';
    }

    const data = {
        naziv: document.getElementById('modalLagerNaziv').value,
        cena: totalCena,
        boja: boja,
        slika: document.getElementById('modalLagerSlika').value,
        kupac: document.getElementById('modalKupac').value,
        kolicina: document.getElementById('modalKolicina').value,
        datum: datumValue,
        placeno: document.getElementById('modalPlaceno').value,
        opis: formattedOpis,
        lager_id: document.getElementById('modalLagerId').value
    };

    try {
        const res = await fetch('/api/order_from_lager', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            alert('Order was successfully created!');
            closeOrderModal();
            loadLager();
        } else {
            alert('Error creating order.');
        }
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
});
</script>
{% endblock %}
