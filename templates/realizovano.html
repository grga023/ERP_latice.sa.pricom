{% extends "base.html" %}

{% block title %}Realizovane porudÅ¾bine{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">âœ… Realizovane PorudÅ¾bine</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Sve porudÅ¾bine koje su uspeÅ¡no zavrÅ¡ene</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid mb-4">
  <div class="stat-card">
    <div class="stat-icon">ğŸ’°</div>
    <div class="stat-value" id="totalSum">0.00</div>
    <div class="stat-label">Ukupna Zarada</div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ğŸ“¦</div>
    <div class="stat-value" id="totalCount">0</div>
    <div class="stat-label">Broj PorudÅ¾bina</div>
  </div>
</div>

<div class="table-container fade-in">
  <table id="shippingTable" class="modern-table">
    <thead>
      <tr>
        <th>Naziv</th>
        <th>Cena</th>
        <th>PlaÄ‡eno</th>
        <th>Kupac</th>
        <th>Datum</th>
        <th>Opis</th>
        <th>Slika</th>
        <th>Akcija</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
function formatOpis(opis) {
    if (!opis || opis === '-') return '-';
    const lines = opis.split(/\r\n|\n/).filter(l => l.trim());
    let kolLines = [];
    let detalji = [];
    let inDetalji = false;
    for (const line of lines) {
        if (line.startsWith('Detalji:')) {
            inDetalji = true;
            detalji.push(line.replace('Detalji:', '').trim());
        } else if (inDetalji) {
            detalji.push(line);
        } else {
            const m = line.match(/^(\d+)\s+(.+)/);
            kolLines.push(m ? m[1] + ' x ' + m[2] : line);
        }
    }
    let html = '';
    if (kolLines.length) html += '<strong>KoliÄina:</strong><br>' + kolLines.join('<br>');
    if (detalji.length) html += (html ? '<br>' : '') + '<strong>Detalji:</strong><br>' + detalji.join('<br>');
    return html || '-';
}
async function loadToBeShipped() {
    const res = await fetch('/api/orders/realized');
    const orders = await res.json();
    const tbody = document.querySelector('#shippingTable tbody');
    tbody.innerHTML = '';

    // Calculate totals
    const totalSum = orders.reduce((sum, o) => sum + (parseFloat(o.cena) || 0), 0);
    document.getElementById('totalSum').textContent = totalSum.toLocaleString('sr-RS', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('totalCount').textContent = orders.length;

    orders.forEach(order => {
        const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="Naziv"><strong>${order.naziv}</strong></td>
                <td data-label="Cena"><strong>${order.cena} RSD</strong></td>
                <td data-label="PlaÄ‡eno">${order.placeno ? '<span class="badge badge-paid">PlaÄ‡eno</span>' : '<span class="badge badge-unpaid">Nije plaÄ‡eno</span>'}</td>
                <td data-label="Kupac"><strong>${order.kupac}</strong></td>
                <td data-label="Datum">${order.datum || '-'}</td>
                <td data-label="Opis" class="td-opis">${formatOpis(order.opis)}</td>
                <td data-label="Slika">${order.slika ? `<img src="/images/${order.slika}" />` : '-'}</td>
                <td data-label="Akcija"><button class="btn btn-sm btn-secondary" onclick="editOrder(${order.id})">âœï¸ Izmeni</button></td>
            `;
            tbody.appendChild(tr);
    });
}

// initial load
loadToBeShipped();

function editOrder(id) {
    window.location.href = `/edit?id=${id}`;
}
</script>
{% endblock %}
