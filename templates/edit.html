{% extends "base.html" %}

{% block title %}Izmeni porudÅ¾binu{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">âœï¸ Izmeni PorudÅ¾binu</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">AÅ¾urirajte detalje porudÅ¾bine</p>
</div>

<div class="form-container fade-in">
  <form id="editForm" enctype="multipart/form-data">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naziv proizvoda</label>
        <input type="text" name="naziv" class="form-input" placeholder="Naziv proizvoda" required>
      </div>

      <div class="form-group">
        <label class="form-label">Cena (RSD)</label>
        <input type="number" name="cena" step="0.01" class="form-input" placeholder="0.00" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">PlaÄ‡eno</label>
        <select name="placeno" class="form-select">
            <option value="false">Ne</option>
            <option value="true">Da</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Kupac</label>
        <input type="text" name="kupac" class="form-input" placeholder="Ime kupca" required>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Datum</label>
      <input type="date" id="datepicker" name="datum" class="form-input" required>
    </div>

    <div class="form-group">
      <label class="form-label">Opis</label>
      <textarea name="opis" class="form-input" rows="4" placeholder="Opis i kombinacije..."></textarea>
    </div>
    
    <div class="form-group">
      <label class="form-label">Slika</label>
      <input type="file" name="slika" accept="image/*" class="form-input" style="padding: 0.75rem;">
    </div>

    <div class="btn-group mt-4">
      <button type="submit" class="btn btn-primary">ğŸ’¾ Spremi izmene</button>
      <button type="button" onclick="cancelEdit()" class="btn btn-secondary">âŒ OtkaÅ¾i</button>
      <button type="button" onclick="returnToLager()" class="btn btn-success">ğŸ“¦ Vrati na Lager</button>
      <button type="button" onclick="deleteOrder()" class="btn btn-danger">ğŸ—‘ï¸ ObriÅ¡i</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    alert('Nema ID-a porudÅ¾bine!');
    window.location.href = '/porudzbenice';
}

// Load order data
async function loadOrder() {
    const res = await fetch(`/api/order/${orderId}`);
    if (!res.ok) {
        alert('PorudÅ¾bina nije pronaÄ‘ena!');
        window.location.href = '/porudzbenice';
        return;
    }
    const order = await res.json();
    
    document.querySelector('[name="naziv"]').value = order.naziv;
    document.querySelector('[name="cena"]').value = order.cena;
    document.querySelector('[name="placeno"]').value = order.placeno ? 'true' : 'false';
    document.querySelector('[name="kupac"]').value = order.kupac;
    
    // Convert datum from DD.MM.YYYY to YYYY-MM-DD for HTML5 date input
    if (order.datum) {
        const [day, month, year] = order.datum.split('.');
        const htmlDate = `${year}-${month}-${day}`;
        document.querySelector('[name="datum"]').value = htmlDate;
    }
    
    document.querySelector('[name="opis"]').value = order.opis;
}

// Handle form submission
const form = document.getElementById('editForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let datumValue = document.querySelector('[name="datum"]').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = `${day}.${month}.${year}`;
    }
    formData.set('datum', datumValue);
    
    try {
        const response = await fetch(`/api/update_order/${orderId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('PorudÅ¾bina je uspeÅ¡no aÅ¾urirana!');
            window.location.href = '/porudzbenice';
        } else {
            alert('GreÅ¡ka pri aÅ¾uriranju porudÅ¾bine.');
        }
    } catch (err) {
        console.error(err);
        alert('GreÅ¡ka pri konektovanju na server.');
    }
});

function cancelEdit() {
    window.location.href = '/porudzbenice';
}

function deleteOrder() {
    if (confirm('Da li ste sigurni da Å¾elite da obriÅ¡ete ovu porudÅ¾binu?')) {
        fetch(`/api/delete_order/${orderId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('PorudÅ¾bina je obrisana!');
                    window.location.href = '/porudzbenice';
                } else {
                    alert(data.error || 'GreÅ¡ka pri brisanju porudÅ¾bine.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('GreÅ¡ka pri konektovanju na server.');
            });
    }
}

function returnToLager() {
    if (confirm('Da li ste sigurni da Å¾elite da vratite ovu porudÅ¾binu na lager?')) {
        fetch(`/api/return_to_lager/${orderId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('PorudÅ¾bina je vraÄ‡ena na lager!');
                    window.location.href = '/porudzbenice';
                } else {
                    alert(data.error || 'GreÅ¡ka pri vraÄ‡anju porudÅ¾bine na lager.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('GreÅ¡ka pri konektovanju na server.');
            });
    }
}

loadOrder();
</script>
{% endblock %}
