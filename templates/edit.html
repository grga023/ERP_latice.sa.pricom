{% extends "base.html" %}

{% block title %}Edit Order{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">âœï¸ Edit Order</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Update order details</p>
</div>

<div class="form-container fade-in">
  <form id="editForm" enctype="multipart/form-data">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Product name</label>
        <input type="text" name="naziv" class="form-input" placeholder="Product name" required>
      </div>

      <div class="form-group">
        <label class="form-label">Price (RSD)</label>
        <input type="number" name="cena" step="0.01" class="form-input" placeholder="0.00" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Paid</label>
        <select name="placeno" class="form-select">
            <option value="false">No</option>
            <option value="true">Yes</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Customer</label>
        <input type="text" name="customer" class="form-input" placeholder="Customer name" required>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Date</label>
      <div style="overflow: hidden; width: 100%; max-width: 100%;">
        <input type="date" id="datepicker" name="date" class="form-input" required style="width: 100%; max-width: 100%; box-sizing: border-box; margin: 0; font-size: 14px;">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea name="description" class="form-input" rows="4" placeholder="Description and combinations..."></textarea>
    </div>
    
    <div class="form-group">
      <label class="form-label">Image</label>
      <input type="file" name="slika" accept="image/*" class="form-input" style="padding: 0.75rem;">
    </div>

    <div class="btn-group mt-4">
      <button type="submit" class="btn btn-primary">ğŸ’¾ Save Changes</button>
      <button type="button" onclick="cancelEdit()" class="btn btn-secondary">âŒ Cancel</button>
      <button type="button" onclick="returnToLager()" class="btn btn-success">ğŸ“¦ Return to Inventory</button>
      <button type="button" onclick="deleteOrder()" class="btn btn-danger">ğŸ—‘ Delete</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    alert('No order ID!');
    window.location.href = '/orders';
}

// Load order data
async function loadOrder() {
    const res = await fetch(`/api/order/${orderId}`);
    if (!res.ok) {
        alert('Order not found!');
        window.location.href = '/orders';
        return;
    }
    const order = await res.json();
    
    document.querySelector('[name="naziv"]').value = order.naziv;
    document.querySelector('[name="cena"]').value = order.cena;
    document.querySelector('[name="placeno"]').value = order.placeno ? 'true' : 'false';
    document.querySelector('[name="kupac"]').value = order.kupac;
    
    // Convert datum from DD.MM.YYYY to YYYY-MM-DD for HTML5 date input
    if (order.datum) {
        const [day, month, year] = order.datum.split('.');
        const htmlDate = `${year}-${month}-${day}`;
        document.querySelector('[name="datum"]').value = htmlDate;
    }
    
    document.querySelector('[name="opis"]').value = order.opis;
}

// Handle form submission
const form = document.getElementById('editForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let datumValue = document.querySelector('[name="datum"]').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = `${day}.${month}.${year}`;
    }
    formData.set('datum', datumValue);
    
    try {
        const response = await fetch(`/api/update_order/${orderId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Order updated successfully!');
            window.location.href = '/orders';
        } else {
            alert('Error updating order.');
        }
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
});

function cancelEdit() {
    window.location.href = '/orders';
}

function deleteOrder() {
    if (confirm('Are you sure you want to delete this order?')) {
        fetch(`/api/delete_order/${orderId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Order deleted!');
                    window.location.href = '/orders';
                } else {
                    alert(data.error || 'Error deleting order.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error connecting to server.');
            });
    }
}

function returnToLager() {
    if (confirm('Are you sure you want to return this order to inventory?')) {
        fetch(`/api/return_to_lager/${orderId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Order returned to inventory!');
                    window.location.href = '/orders';
                } else {
                    alert(data.error || 'Error returning order to inventory.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error connecting to server.');
            });
    }
}

loadOrder();
</script>
{% endblock %}
