{% extends "base.html" %}

{% block title %}Izmeni porudžbinu{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="container" id="form-container">
<h1>Izmeni porudžbinu</h1>

<form id="editForm" enctype="multipart/form-data">
    <div class="form-field">
        <label>Naziv proizvoda:</label>
        <input type="text" name="naziv" required>
    </div>

    <div class="form-field">
        <label>Cena:</label>
        <input type="number" name="cena" step="0.01" required>
    </div>

    <div class="form-field">
        <label>Plaćeno:</label>
        <select name="placeno">
            <option value="false">Ne</option>
            <option value="true">Da</option>
        </select>
    </div>

    <div class="form-field">
        <label>Kupac:</label>
        <input type="text" name="kupac" required>
    </div>

    <label>Datum:</label>
    <input type="date" id="datepicker" name="datum" required>

    <label>Opis:</label>
    <textarea name="opis" placeholder="Opis i kombinacije..."></textarea>
    
    <label>Slika:</label>
    <input type="file" name="slika" accept="image/*">

    <button type="submit">Spremi izmene</button>
    <button type="button" onclick="cancelEdit()">Otkaži</button>
    <button type="button" onclick="deleteOrder()">Obrisi</button>
    <button type="button" onclick="returnToLager()">Vrati na Lager</button>
</form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    alert('Nema ID-a porudžbine!');
    window.location.href = '/porudzbenice';
}

// Load order data
async function loadOrder() {
    const res = await fetch(`/api/order/${orderId}`);
    if (!res.ok) {
        alert('Porudžbina nije pronađena!');
        window.location.href = '/porudzbenice';
        return;
    }
    const order = await res.json();
    
    document.querySelector('[name="naziv"]').value = order.naziv;
    document.querySelector('[name="cena"]').value = order.cena;
    document.querySelector('[name="placeno"]').value = order.placeno ? 'true' : 'false';
    document.querySelector('[name="kupac"]').value = order.kupac;
    
    // Convert datum from DD.MM.YYYY to YYYY-MM-DD for HTML5 date input
    if (order.datum) {
        const [day, month, year] = order.datum.split('.');
        const htmlDate = `${year}-${month}-${day}`;
        document.querySelector('[name="datum"]').value = htmlDate;
    }
    
    document.querySelector('[name="opis"]').value = order.opis;
}

// Handle form submission
const form = document.getElementById('editForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let datumValue = document.querySelector('[name="datum"]').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = `${day}.${month}.${year}`;
    }
    formData.set('datum', datumValue);
    
    try {
        const response = await fetch(`/api/update_order/${orderId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Porudžbina je uspešno ažurirana!');
            window.location.href = '/porudzbenice';
        } else {
            alert('Greška pri ažuriranju porudžbine.');
        }
    } catch (err) {
        console.error(err);
        alert('Greška pri konektovanju na server.');
    }
});

function cancelEdit() {
    window.location.href = '/porudzbenice';
}

function deleteOrder() {
    if (confirm('Da li ste sigurni da želite da obrišete ovu porudžbinu?')) {
        fetch(`/api/delete_order/${orderId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Porudžbina je obrisana!');
                    window.location.href = '/porudzbenice';
                } else {
                    alert(data.error || 'Greška pri brisanju porudžbine.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Greška pri konektovanju na server.');
            });
    }
}

function returnToLager() {
    if (confirm('Da li ste sigurni da želite da vratite ovu porudžbinu na lager?')) {
        fetch(`/api/return_to_lager/${orderId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Porudžbina je vraćena na lager!');
                    window.location.href = '/porudzbenice';
                } else {
                    alert(data.error || 'Greška pri vraćanju porudžbine na lager.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Greška pri konektovanju na server.');
            });
    }
}

loadOrder();
</script>
{% endblock %}
