{% extends "base.html" %}

{% block title %}Edit order{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">âœï¸ Edit Order</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Update order details</p>
</div>

<div class="form-container fade-in">
  <form id="editForm" enctype="multipart/form-data">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Naziv proizvoda</label>
        <input type="text" name="name" class="form-input" placeholder="Naziv proizvoda" required>
      </div>

      <div class="form-group">
        <label class="form-label">Cena (RSD)</label>
        <input type="number" name="price" step="0.01" class="form-input" placeholder="0.00" required>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Paid</label>
        <select name="paid" class="form-select">
            <option value="false">Ne</option>
            <option value="true">Da</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Kupac</label>
        <input type="text" name="customer" class="form-input" placeholder="Ime kupca" required>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Datum</label>
      <input type="date" id="datepicker" name="date" class="form-input" required>
    </div>

    <div class="form-group">
      <label class="form-label">Opis</label>
      <textarea name="description" class="form-input" rows="4" placeholder="Opis i kombinacije..."></textarea>
    </div>
    
    <div class="form-group">
      <label class="form-label">Slika</label>
      <input type="file" name="image" accept="image/*" class="form-input" style="padding: 0.75rem;">
    </div>

    <div class="btn-group mt-4">
      <button type="submit" class="btn btn-primary">ğŸ’¾ Spremi izmene</button>
      <button type="button" onclick="cancelEdit()" class="btn btn-secondary">âŒ Cancel</button>
      <button type="button" onclick="returnToLager()" class="btn btn-success">ğŸ“¦ Vrati na Lager</button>
      <button type="button" onclick="deleteOrder()" class="btn btn-danger">ğŸ—‘ï¸ Delete</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    alert('No order ID!');
    window.location.href = '/new-orders';
}

// Load order data
async function loadOrder() {
    const res = await fetch(`/api/order/${orderId}`);
    if (!res.ok) {
        alert('Order not found!');
        window.location.href = '/new-orders';
        return;
    }
    const order = await res.json();
    
    document.querySelector('[name="name"]').value = order.name;
    document.querySelector('[name="price"]').value = order.price;
    document.querySelector('[name="paid"]').value = order.paid ? 'true' : 'false';
    document.querySelector('[name="customer"]').value = order.customer;
    
    // Convert date from DD.MM.YYYY to YYYY-MM-DD for HTML5 date input
    if (order.date) {
        const [day, month, year] = order.date.split('.');
        const htmlDate = `${year}-${month}-${day}`;
        document.querySelector('[name="date"]').value = htmlDate;
    }
    
    document.querySelector('[name="description"]').value = order.description;
}

// Handle form submission
const form = document.getElementById('editForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let dateValue = document.querySelector('[name="date"]').value;
    if (dateValue) {
        const [year, month, day] = dateValue.split('-');
        dateValue = `${day}.${month}.${year}`;
    }
    formData.set('date', dateValue);
    
    try {
        const response = await fetch(`/api/update_order/${orderId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Order successfully updated!');
            window.location.href = '/new-orders';
        } else {
            alert('Error updating order.');
        }
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
});

function cancelEdit() {
    window.location.href = '/new-orders';
}

function deleteOrder() {
    if (confirm('Are you sure you want to delete this order?')) {
        fetch(`/api/delete_order/${orderId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Order deleted!');
                    window.location.href = '/new-orders';
                } else {
                    alert(data.error || 'Error deleting order.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error connecting to server.');
            });
    }
}

function returnToLager() {
    if (confirm('Are you sure you want to return this order to inventory?')) {
        fetch(`/api/return_to_lager/${orderId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    alert('Order returned to inventory!');
                    window.location.href = '/new-orders';
                } else {
                    alert(data.error || 'Error returning order to inventory.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error connecting to server.');
            });
    }
}

loadOrder();
</script>
{% endblock %}
