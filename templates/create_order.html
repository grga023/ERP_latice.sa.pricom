{% extends "base.html" %}

{% block title %}Create Order{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">â• Create Order</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Add a new order to the system</p>
</div>

<!-- Stats Cards (Optional - uncomment when stats API is ready) -->
<!--
<div class="stats-grid mb-5">
  <div class="stat-card">
    <div class="stat-icon">ğŸ“‹</div>
    <div class="stat-value">24</div>
    <div class="stat-label">New Orders</div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ğŸšš</div>
    <div class="stat-value">12</div>
    <div class="stat-label">For Delivery</div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">âœ…</div>
    <div class="stat-value">156</div>
    <div class="stat-label">Completed</div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ğŸ’°</div>
    <div class="stat-value">45.2k</div>
    <div class="stat-label">Total Revenue</div>
  </div>
</div>
-->

<!-- Main Form Card -->
<div class="form-container fade-in">
  <div class="card-header mb-4">
    <h2 class="card-title">â• New Order</h2>
  </div>

  <form id="orderForm" enctype="multipart/form-data">
    <!-- Row 1: Name and Price -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Product name *</label>
        <input type="text" name="name" class="form-input" placeholder="Enter product name" required>
      </div>

      <div class="form-group">
        <label class="form-label">Price (per unit) *</label>
        <input type="number" name="price" step="0.01" class="form-input" placeholder="0.00" required>
      </div>
    </div>

    <!-- Row 2: Paid and Customer -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Paid</label>
        <select name="paid" class="form-select">
          <option value="false">âŒ No</option>
          <option value="true">âœ… Yes</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" style="font-weight: 700;">Customer *</label>
        <input type="text" name="customer" class="form-input" placeholder="Customer name" required>
      </div>
    </div>

    <!-- Row 3: Delivery Date -->
    <div class="form-group">
      <label class="form-label">Delivery date *</label>
      <div style="overflow: hidden; width: 100%; max-width: 100%;">
        <input type="date" id="datepicker" name="date" class="form-input" required style="width: 100%; max-width: 100%; box-sizing: border-box; margin: 0; font-size: 14px;">
      </div>
    </div>

    <!-- Combinations of color and quantity -->
    <div class="form-group">
      <label class="form-label">Quantity and colors</label>
      <div id="kombinacije-container" style="display: flex; flex-direction: column; gap: 0.75rem;">
        <div class="kombinacija-row">
          <input type="number" class="quantity form-input" min="1" value="1" placeholder="Quantity" required>
          <input type="text" class="color form-input" value="various" placeholder="Color" required>
          <button type="button" class="btn btn-danger btn-sm btn-remove" onclick="removeCombination(this)">Ã—</button>
          <button type="button" class="btn btn-success btn-sm btn-add" onclick="addCombination()">+ Add</button>
        </div>
      </div>
    </div>

    <!-- Additional notes -->
    <div class="form-group">
      <label class="form-label">Additional notes</label>
      <textarea id="customMessage" name="customMessage" class="form-textarea" placeholder="Enter additional details, notes or special requests..."></textarea>
    </div>

    <!-- Hidden field for formatted description -->
    <input type="hidden" name="description" id="descriptionField">

    <!-- Product Image Upload -->
    <div class="form-group">
      <label class="form-label">Product image</label>
      <div id="pasteArea" class="image-upload" style="position: relative;">
        <input type="file" id="fileInput" name="image" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
        <p style="margin: 0; font-weight: 500; color: var(--gray);">ğŸ“ Click to select or press CTRL+V</p>
      </div>
      <img id="preview" class="image-preview mt-3" alt="Image preview" style="display: none;">
    </div>

    <!-- Submit Button -->
    <div class="btn-group mt-4">
      <button type="submit" class="btn btn-primary btn-lg w-full">
        <span>âœ¨</span>
        <span>Add Order</span>
      </button>
    </div>
  </form>
</div>

<!-- Quick Links -->
<div class="grid grid-3 mt-5">
  <a href="/dashboard" class="card text-center" style="text-decoration: none; color: inherit;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
    <h3 class="gradient-text" style="margin-bottom: 0.5rem;">Dashboard</h3>
    <p style=\"color: var(--gray); margin: 0;\">Return to dashboard</p>
  </a>

  <a href="/new-orders" class="card text-center" style="text-decoration: none; color: inherit;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“‹</div>
    <h3 class=\"gradient-text\" style=\"margin-bottom: 0.5rem;\">New Orders</h3>
    <p style=\"color: var(--gray); margin: 0;\">View new orders</p>
  </a>

  <a href="/for-delivery" class="card text-center" style="text-decoration: none; color: inherit;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸšš</div>
    <h3 class="gradient-text" style="margin-bottom: 0.5rem;">For Delivery</h3>
    <p style="color: var(--gray); margin: 0;">View delivery orders</p>
  </a>

  <a href="/inventory" class="card text-center" style="text-decoration: none; color: inherit;">
    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¦</div>
    <h3 class="gradient-text" style="margin-bottom: 0.5rem;">Inventory</h3>
    <p style="color: var(--gray); margin: 0;">Manage stock</p>
  </a>
</div>

{% endblock %}

{% block scripts %}
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–¼ï¸ IMAGE PASTE & PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pasteArea = document.getElementById("pasteArea");
const preview = document.getElementById("preview");
const fileInput = document.getElementById("fileInput");

pasteArea.addEventListener("paste", function (e) {
  const items = e.clipboardData.items;

  for (let i = 0; i < items.length; i++) {
    if (items[i].type.indexOf("image") !== -1) {
      const file = items[i].getAsFile();

      // Preview
      const reader = new FileReader();
      reader.onload = function (event) {
        preview.src = event.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);

      // Add to file input
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      break;
    }
  }
});

fileInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      preview.src = event.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ KOMBINACIJE (Color + Quantity)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCombination() {
  const container = document.getElementById('kombinacije-container');
  const newRow = document.createElement('div');
  newRow.className = 'kombinacija-row';
  newRow.innerHTML = `
    <input type="number" class="quantity form-input" min="1" value="1" placeholder="Quantity" required>
    <input type="text" class="color form-input" value="razno" placeholder="Boja" required>
    <button type="button" class="btn btn-danger btn-sm btn-remove" onclick="removeCombination(this)">Ã—</button>
  `;
  container.appendChild(newRow);
}

function removeCombination(btn) {
  const container = document.getElementById('kombinacije-container');
  if (container.children.length > 1) {
    btn.parentElement.remove();
  }
}

function formatCombinations() {
  const rows = document.querySelectorAll('.kombinacija-row');
  let formatted = '';
  
  rows.forEach(row => {
    const quantity = row.querySelector('.quantity').value;
    const color = row.querySelector('.color').value;
    if (quantity && color) {
      formatted += quantity + ' ' + color + '\r\n';
    }
  });
  
  const customMessage = document.getElementById('customMessage').value.trim();
  if (customMessage) {
    formatted += 'Details: ' + customMessage + '\r\n';
  }
  
  document.querySelector('#descriptionField').value = formatted;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ FORM SUBMISSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const form = document.getElementById('orderForm');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Format combinations before submitting
  formatCombinations();

  const formData = new FormData(form);

  // Calculate total quantity and first color
  const rows = document.querySelectorAll('.kombinacija-row');
  let totalKolicina = 0;
  let firstBoja = '';
  rows.forEach((row, index) => {
    const k = parseInt(row.querySelector('.quantity').value) || 0;
    totalKolicina += k;
    if (index === 0) {
      firstBoja = row.querySelector('.color').value || '';
    }
  });
  if (totalKolicina < 1) totalKolicina = 1;
  
  // Add quantity and color fields for backend
  formData.set('quantity', totalKolicina);
  formData.set('color', firstBoja);
  
  // Multiply price by total quantity
  const baseCena = parseFloat(formData.get('price'));
  formData.set('price', (baseCena * totalKolicina).toFixed(2));

  // Convert date from YYYY-MM-DD to DD.MM.YYYY format
  let dateValue = document.querySelector('#datepicker').value;
  if (dateValue) {
    const [year, month, day] = dateValue.split('-');
    dateValue = `${day}.${month}.${year}`;
  }
  formData.set('date', dateValue);

  try {
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>â³</span><span>Adding...</span>';

    const response = await fetch('/api/orders', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      // Success animation
      submitBtn.innerHTML = '<span>âœ…</span><span>Success!</span>';
      setTimeout(() => {
        alert('Order has been successfully added!');
        form.reset();
        preview.style.display = 'none';
        // Reset quantities
        document.getElementById('kombinacije-container').innerHTML = `
          <div class="kombinacija-row">
            <input type="number" class="quantity form-input" min="1" value="1" placeholder="Quantity" required>
            <input type="text" class="color form-input" value="various" placeholder="Color" required>
            <button type="button" class="btn btn-danger btn-sm btn-remove" onclick="removeCombination(this)">Ã—</button>
            <button type="button" class="btn btn-success btn-sm btn-add" onclick="addCombination()">+ Add</button>
          </div>
        `;
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>âœ¨</span><span>Add Order</span>';
      }, 1000);
    } else {
      const errorData = await response.json();
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>âŒ</span><span>Try again</span>';
      setTimeout(() => {
        submitBtn.innerHTML = '<span>âœ¨</span><span>Add Order</span>';
      }, 2000);
      alert('Error adding order: ' + (errorData.error || 'Unknown error'));
    }
  } catch (err) {
    console.error(err);
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>âŒ</span><span>Try again</span>';
    setTimeout(() => {
      submitBtn.innerHTML = '<span>âœ¨</span><span>Add Order</span>';
    }, 2000);
    alert('Error connecting to server: ' + err.message);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“… DATE PICKER INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (typeof flatpickr !== 'undefined') {
  flatpickr("#datepicker", {
    dateFormat: "Y-m-d",
    minDate: "today"
  });
}
</script>
{% endblock %}
