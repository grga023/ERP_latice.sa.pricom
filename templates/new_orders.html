{% extends "base.html" %}

{% block title %}New Orders{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; color: #1a1a1a;">üìã New Orders</h1>
  <p style="color: #4a4a4a; font-size: 1.1rem;">Overview of all new orders waiting for processing</p>
</div>

<div class="table-container fade-in">
  <table id="ordersTable" class="modern-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Paid</th>
        <th>Customer</th>
        <th>Date</th>
        <th>Description</th>
        <th>Image</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modern Modal for payment confirmation -->
<div id="paymentModal" class="modal-overlay" style="align-items: center; justify-content: center;">
  <div class="card" style="max-width: 500px; margin: 2rem; animation: slideInUp 0.3s ease;">
    <div class="card-header">
      <h2 class="card-title" style="margin: 0;">üí≥ Payment Confirmation</h2>
      <button onclick="closePaymentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">&times;</button>
    </div>
    <div class="card-body">
      <p style="color: var(--gray); margin-bottom: 1.5rem;">This order has not been paid yet. Has the customer paid?</p>
      <div class="btn-group">
        <button id="btnPlaceno" class="btn btn-success btn-lg">‚úÖ Yes, paid</button>
        <button id="btnNijePlaceno" class="btn btn-danger btn-lg">‚ùå No, not paid</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function formatDescription(description) {
    if (!description || description === '-') return '-';
    const lines = description.split(/\r\n|\n/).filter(l => l.trim());
    let quantityLines = [];
    let details = [];
    let inDetails = false;
    for (const line of lines) {
        if (line.startsWith('Details:')) {
            inDetails = true;
            details.push(line.replace('Details:', '').trim());
        } else if (inDetails) {
            details.push(line);
        } else {
            // Format "3 Red" ‚Üí "3 x Red"
            const m = line.match(/^(\d+)\s+(.+)/);
            quantityLines.push(m ? m[1] + ' x ' + m[2] : line);
        }
    }
    let html = '';
    if (quantityLines.length) html += '<strong>Quantity:</strong><br>' + quantityLines.join('<br>');
    if (details.length) html += (html ? '<br>' : '') + '<strong>Details:</strong><br>' + details.join('<br>');
    return html || '-';
}
async function loadOrders() {
    const res = await fetch('/api/orders/new');
    const orders = await res.json();
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = '';

    orders.forEach(order => {
        const tr = document.createElement('tr');
            tr.innerHTML = `
                <td data-label="Name"><strong>${order.name}</strong></td>
                <td data-label="Price"><strong>${order.price} RSD</strong></td>
                <td data-label="Paid">${order.paid ? '<span class="badge badge-paid">Paid</span>' : '<span class="badge badge-unpaid">Not paid</span>'}</td>
                <td data-label="Customer"><strong>${order.customer}</strong></td>
                <td data-label="Date">${order.date || '-'}</td>
                <td data-label="Description" class="td-description">${formatDescription(order.description)}</td>
                <td data-label="Image">${order.image ? `<img src="/images/${order.image}" />` : '-'}</td>
                <td data-label="Action">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary" onclick="editOrder(${order.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-success" onclick="forDelivery(${order.id}, ${order.paid})">üöö Delivery</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
    });
}

async function forDelivery(id, paid) {
    if (!paid) {
        // Show payment modal
        const modal = document.getElementById('paymentModal');
        modal.classList.add('active');

        // Remove old listeners by cloning buttons
        const btnDa = document.getElementById('btnPlaceno');
        const btnNe = document.getElementById('btnNijePlaceno');
        const newBtnDa = btnDa.cloneNode(true);
        const newBtnNe = btnNe.cloneNode(true);
        btnDa.parentNode.replaceChild(newBtnDa, btnDa);
        btnNe.parentNode.replaceChild(newBtnNe, btnNe);

        newBtnDa.addEventListener('click', async () => {
            modal.classList.remove('active');
            await sendDelivery(id, true);
        });
        newBtnNe.addEventListener('click', async () => {
            modal.classList.remove('active');
            await sendDelivery(id, false);
        });

        // Close on overlay click
        modal.onclick = function(e) {
            if (e.target === modal) modal.classList.remove('active');
        };
        return;
    }
    await sendDelivery(id, paid);
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
}

async function sendDelivery(id, paid) {
    try {
        const res = await fetch('/api/update_status', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({id: id, status:'for_delivery', paid: paid})
        });
        if(res.ok) loadOrders();
        else alert('Error updating status.');
    } catch (err) {
        console.error(err);
        alert('Error connecting to server.');
    }
}

function editOrder(id) {
    window.location.href = `/edit?id=${id}`;
}

// initial load
loadOrders();
</script>
{% endblock %}
