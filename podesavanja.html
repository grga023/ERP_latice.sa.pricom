<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Latice sa pricom - PodeÅ¡avanja</title>
<link rel="stylesheet" href="style.css?v=3">
<script src="script.js"></script>
</head>
<body>

<nav class="topnav">
  <button class="hamburger" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="nav-menu">
    <a href="index.html">Dodaj porudÅ¾binu</a>
    <a href="porudzbenice.html">Nove porudÅ¾bine</a>
    <a href="realizovano.html">Realizovane porudÅ¾bine</a>
    <a href="za_daostavu.html">Za dostavu</a>
    <a href="lager.html">Lager</a>
    <a href="podesavanja.html">âš™ PodeÅ¡avanja</a>
  </div>
  <button class="theme-toggle" onclick="toggleDarkMode()">ğŸŒ™ Dark Mode</button>
</nav>

<div class="container">
<h1>âš™ PodeÅ¡avanja notifikacija</h1>

<div class="settings-card">
    <h2>ğŸ“§ Email notifikacije</h2>
    <p class="settings-desc">PrimaÄ‡eÅ¡ email obaveÅ¡tenje kada porudÅ¾bina ima rok u narednih N dana. KoristiÅ¡ Gmail sa App Password-om.</p>

    <form id="emailForm" class="settings-form">
        <div class="form-field">
            <label>Notifikacije:</label>
            <select id="emailEnabled">
                <option value="false">IskljuÄeno</option>
                <option value="true">UkljuÄeno</option>
            </select>
        </div>

        <div class="form-field">
            <label>Gmail za slanje:</label>
            <input type="email" id="senderEmail" placeholder="tvoj.email@gmail.com" required>
        </div>

        <div class="form-field">
            <label>App Password:</label>
            <input type="password" id="appPassword" placeholder="Unesi Gmail App Password">
            <small id="passwordHint" style="color: var(--text-secondary);"></small>
        </div>

        <div class="form-field">
            <label>Primaoc (email):</label>
            <input type="email" id="receiverEmail" placeholder="primaoc@email.com" required>
        </div>

        <div class="form-field">
            <label>Dana pre roka:</label>
            <input type="number" id="daysBefore" min="1" max="14" value="2">
        </div>

        <div class="settings-buttons">
            <button type="submit">ğŸ’¾ SaÄuvaj</button>
            <button type="button" onclick="testEmail()">ğŸ“¨ Test Email</button>
            <button type="button" onclick="triggerCheck()">ğŸ”” Proveri sad</button>
        </div>
    </form>

    <div id="statusMsg" class="status-msg" style="display:none;"></div>
</div>
</div>

<script>
async function loadConfig() {
    const res = await fetch('/email_config');
    const config = await res.json();
    document.getElementById('emailEnabled').value = config.enabled ? 'true' : 'false';
    document.getElementById('senderEmail').value = config.sender_email || '';
    document.getElementById('receiverEmail').value = config.receiver_email || '';
    document.getElementById('daysBefore').value = config.days_before || 2;
    if (config.has_password) {
        document.getElementById('passwordHint').textContent = 'âœ… Password je saÄuvan. Ostavi prazno ako ne menjaÅ¡.';
    }
}

function showStatus(msg, ok) {
    const el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = ok ? '#d4edda' : '#f8d7da';
    el.style.color = ok ? '#155724' : '#721c24';
    el.style.border = ok ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
}

document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        enabled: document.getElementById('emailEnabled').value === 'true',
        sender_email: document.getElementById('senderEmail').value,
        receiver_email: document.getElementById('receiverEmail').value,
        days_before: parseInt(document.getElementById('daysBefore').value),
    };
    const pw = document.getElementById('appPassword').value;
    if (pw) data.app_password = pw;

    try {
        const res = await fetch('/email_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (res.ok) {
            showStatus('PodeÅ¡avanja su saÄuvana!', true);
            document.getElementById('appPassword').value = '';
            loadConfig();
        } else {
            showStatus('GreÅ¡ka pri Äuvanju.', false);
        }
    } catch (err) {
        showStatus('GreÅ¡ka pri konekciji.', false);
    }
});

async function testEmail() {
    showStatus('Å aljem test email...', true);
    try {
        const res = await fetch('/test_email', { method: 'POST' });
        const data = await res.json();
        if (data.ok) showStatus('âœ… Test email je uspeÅ¡no poslat!', true);
        else showStatus('âŒ GreÅ¡ka: ' + (data.error || 'Neuspelo slanje.'), false);
    } catch (err) {
        showStatus('GreÅ¡ka pri konekciji.', false);
    }
}

async function triggerCheck() {
    showStatus('Proveravam porudÅ¾bine...', true);
    try {
        const res = await fetch('/check_notifications', { method: 'POST' });
        if (res.ok) showStatus('âœ… Provera zavrÅ¡ena! Ako ima porudÅ¾bina sa bliskim rokom, email je poslat.', true);
        else showStatus('GreÅ¡ka pri proveri.', false);
    } catch (err) {
        showStatus('GreÅ¡ka pri konekciji.', false);
    }
}

loadConfig();
</script>

</body>
</html>
