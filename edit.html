<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Latice sa pricom - Izmeni porud≈æbinu</title>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>

<!-- Navigation bar -->
<nav class="topnav">
  <button class="hamburger" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <div class="nav-menu">
    <a href="index.html">Dodaj porud≈æbinu</a>
    <a href="porudzbenice.html">Nove porud≈æbine</a>
    <a href="realizovano.html">Realizovane porud≈æbine</a>
    <a href="za_daostavu.html">Za dostavu</a>
    <a href="lager.html">Lager</a>
  </div>
  <button class="theme-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
</nav>

<div class="container" id="form-container">
<h1>Izmeni porud≈æbinu</h1>

<form id="editForm" enctype="multipart/form-data">
    <div class="form-field">
        <label>Naziv proizvoda:</label>
        <input type="text" name="naziv" required>
    </div>

    <div class="form-field">
        <label>Cena:</label>
        <input type="number" name="cena" step="0.01" required>
    </div>

    <div class="form-field">
        <label>Plaƒáeno:</label>
        <select name="placeno">
            <option value="false">Ne</option>
            <option value="true">Da</option>
        </select>
    </div>

    <div class="form-field">
        <label>Kupac:</label>
        <input type="text" name="kupac" required>
    </div>

    <label>Datum:</label>
    <input type="date" id="datepicker" name="datum" required>

    <label>Opis:</label>
    <textarea name="opis" placeholder="Opis i kombinacije..."></textarea>
    
    <label>Slika:</label>
    <input type="file" name="slika" accept="image/*">

    <button type="submit">Spremi izmene</button>
    <button type="button" onclick="cancelEdit()">Otka≈æi</button>
</form>
</div>

<script src="script.js"></script>
<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    alert('Nema ID-a porud≈æbine!');
    window.location.href = 'porudzbenice.html';
}

// Load order data
async function loadOrder() {
    const res = await fetch(`/order/${orderId}`);
    if (!res.ok) {
        alert('Porud≈æbina nije pronaƒëena!');
        window.location.href = 'porudzbenice.html';
        return;
    }
    const order = await res.json();
    
    document.querySelector('[name="naziv"]').value = order.naziv;
    document.querySelector('[name="cena"]').value = order.cena;
    document.querySelector('[name="placeno"]').value = order.placeno ? 'true' : 'false';
    document.querySelector('[name="kupac"]').value = order.kupac;
    
    // Convert datum from DD.MM.YYYY to YYYY-MM-DD for HTML5 date input
    if (order.datum) {
        const [day, month, year] = order.datum.split('.');
        const htmlDate = `${year}-${month}-${day}`;
        document.querySelector('[name="datum"]').value = htmlDate;
    }
    
    document.querySelector('[name="opis"]').value = order.opis;
}

// Handle form submission
const form = document.getElementById('editForm');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Convert date from YYYY-MM-DD to DD.MM.YYYY format
    let datumValue = document.querySelector('[name="datum"]').value;
    if (datumValue) {
        const [year, month, day] = datumValue.split('-');
        datumValue = `${day}.${month}.${year}`;
    }
    formData.set('datum', datumValue);
    
    try {
        const response = await fetch(`/update_order/${orderId}`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Porud≈æbina je uspe≈°no a≈æurirana!');
            window.location.href = 'porudzbenice.html';
        } else {
            alert('Gre≈°ka pri a≈æuriranju porud≈æbine.');
        }
    } catch (err) {
        console.error(err);
        alert('Gre≈°ka pri konektovanju na server.');
    }
});

function cancelEdit() {
    window.location.href = 'porudzbenice.html';
}

loadOrder();
</script>

</body>
</html>
